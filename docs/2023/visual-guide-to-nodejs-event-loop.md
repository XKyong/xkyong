# 【翻译】一篇理解Node.js事件循环的完整可视化指南

> 原文地址：https://www.builder.io/blog/visual-guide-to-nodejs-event-loop

你已经使用 Node.js 有一段时间了。您已经构建了一些应用程序，玩转了不同的模块，甚至对异步编程已经驾轻就熟。但有件事一直让你耿耿于怀——事件循环。

如果你和我一样，已经花了无数的时间阅读文档和观看视频，试图理解事件循环。但是，即使是经验丰富的开发人员，也很难完全了解它是如何工作的。因此，我编写了这篇可视化指南，帮助你全面理解 Node.js 事件循环。坐下来，喝杯咖啡，让我们一起深入了解 Node.js 事件循环的世界。

## JavaScript中的异步编程

首先，我们将复习一下 JavaScript 中的异步编程。虽然 JavaScript 在网络、移动和桌面应用程序中都有使用，但重要的是要记住JavaScript 最基本的形式，即**JavaScript是同步、阻塞、单线程的语言**。让我们通过一段简短的代码来理解这一点。

```js
// index.js

function A() {
  console.log("A");
}

function B() {
  console.log("B");
}

A()
B()

// Logs A and then B
```

### JavaScript是同步的

如果我们有两个向控制台打印信息的函数，代码会自上而下地执行，任何时候都只执行一行。在代码片段中，我们可以看到 A 在 B 之前打印。

### JavaScript是阻塞的

JavaScript 的同步特性决定了它是阻塞的。无论前一个程序需要多长时间，在前一个程序完成之前，后一个程序都不会启动。在代码片段中，如果函数 A 需要执行一段密集代码，JavaScript 必须在完成这段代码后才会转到函数 B。

您可能在浏览器中体验过这种情况。当网络应用程序在浏览器中运行时，如果执行了大量代码却不将控制权返回给浏览器，浏览器就会“卡住”。这就是所谓的阻塞。在网络应用程序返回处理器控制权之前，浏览器将被阻止继续处理用户输入和执行其他任务。

### JavaScript是单线程的

线程只是 JavaScript 程序用来运行任务的一个*程序*。每个线程一次只能执行一个任务。与其他一些支持多线程从而可以并行运行多个任务的语言不同，JavaScript 只有一个线程，称为主线程，用于执行任何代码。

### 等待JavaScript

你可能已经猜到了，JavaScript 的这种模式会带来一个问题，因为我们必须等待数据被获取，然后才能继续执行代码。这个等待过程可能需要几秒钟，在此期间我们无法运行任何代码。如果 JavaScript 在不等待的情况下继续执行，我们就会遇到错误。我们需要一种在 JavaScript 中实现异步行为的方式。这就是 Node.js。

## Node.js运行时

![image-20230926222606083](img/visual-guide-to-nodejs-event-loop/image-20230926222606083.png)

Node.js 运行时是一个可以在浏览器外使用和运行 JavaScript 程序的环境。Node 运行时的核心由三个主要组件组成。

- Node.js 运行所需的外部依赖项，如 V8、libuv 和 crypto
- 提供文件系统访问和网络等功能的 C++ 特性
- 提供函数和实用程序的 JavaScript 库，以便从 JavaScript 代码中获取 C++ 功能

虽然所有部分都很重要，但 Node.js 异步编程的关键部分是外部依赖项 libuv。

## Libuv

[Libuv](https://libuv.org/) 是一个用 C 语言编写的跨平台开源库。在 Node.js 运行时中，它的作用是为处理异步操作提供支持。让我们来看看它是如何工作的。

### 在 Node.js 运行时中执行代码

![image-20230926222657146](img/visual-guide-to-nodejs-event-loop/image-20230926222657146.png)

让我们概念化一下代码在 Node 运行时中通常是如何执行的。当我们执行代码时，位于图片左侧的 V8 引擎会处理 JavaScript 代码的执行。该引擎由内存堆和调用栈组成。

每当我们声明变量或函数时，内存就会在堆上分配；每当我们执行代码时，函数就会被推入调用栈。函数返回时，会从调用栈中弹出。这是堆栈数据结构的直接实现，最后添加的项目就是第一个要移除的项目。在图片的右侧，我们看到了负责处理异步方法的 libuv。

每当我们执行异步方法时，libuv 就会接管任务的执行。然后，libuv 使用操作系统的本地异步机制运行任务。如果本地机制不可用或不够用，它就会利用线程池来运行任务，确保主线程不会被阻塞。

### 同步代码执行

![](img/visual-guide-to-nodejs-event-loop/截图_20230926222938.gif)



### 异步代码执行

![](img/visual-guide-to-nodejs-event-loop/截图_20230926223203.gif)



### Libuv和异步操作





## 什么是事件循环







## 可视化事件循环

![image-20230926223457570](img/visual-guide-to-nodejs-event-loop/image-20230926223457570.png)





## 事件循环如何工作





![image-20230926223457570](img/visual-guide-to-nodejs-event-loop/image-20230926223457570.png)













## 总结

事件循环是 Node.js 的基本组成部分，它通过确保主线程不被阻塞来实现异步编程。理解事件循环的工作原理可能具有挑战性，但它对于构建性能良好的应用程序至关重要。

本篇可视化指南涵盖了 JavaScript、Node.js 运行时和负责处理异步操作的 libuv 中异步编程的基础知识。有了这些知识，你就可以建立一个强大的事件循环心智模型，这将有助于你利用 Node.js 的异步特性编写代码。

